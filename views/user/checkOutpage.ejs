<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Elite Wear - Checkout</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- AOS Animation Library -->
<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
<!-- Custom CSS -->
<link rel="stylesheet" href="/userStyle/header.css">
<link rel="stylesheet" href="/userStyle/footer.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="/userStyle/checkOut.css">
</head>
<body>
<!-- Preloader -->


<!-- Scroll Indicator -->
<div class="scroll-indicator"></div>

<!-- Cursor Glow Effect -->
<div class="cursor-glow"></div>

<%- include("../partials/user/header") %>

<div class="container my-5">
  <div class="checkout-header-wrapper" data-aos="fade-up">
    <h2 class="checkout-header">CHECKOUT</h2>
  </div>

  <!-- Progress Bar -->
  <div class="checkout-progress-container" data-aos="fade-up" data-aos-delay="100">
    <div class="checkout-progress">
      <div class="progress-step completed">
        <div class="step-icon">
          <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="step-label">Cart</div>
      </div>
      <div class="progress-connector active"></div>
      <div class="progress-step active">
        <div class="step-icon">
          <i class="fas fa-map-marker-alt"></i>
        </div>
        <div class="step-label">Delivery</div>
      </div>
      <div class="progress-connector"></div>
      <div class="progress-step">
        <div class="step-icon">
          <i class="fas fa-credit-card"></i>
        </div>
        <div class="step-label">Payment</div>
      </div>
      <div class="progress-connector"></div>
      <div class="progress-step">
        <div class="step-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="step-label">Confirmation</div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Order Summary Section -->
    <div class="col-lg-4 order-lg-2">
      <div class="order-summary-card" data-aos="fade-left" data-aos-delay="200">
        <div class="card-header">
          <h5>Order Summary</h5>
          <span class="badge bg-primary"><%= cartItems.length %> items</span>
        </div>
        
        <!-- Order Items Preview Section -->
        <div class="order-items-preview">
          <% cartItems.slice(0, 3).forEach(item => { %>
            <div class="order-item-preview">
              <div class="item-image">
                <% 
                  let imageUrl = '/placeholder.svg?height=60&width=60&query=fashion+product';
                  if (item && item.productId) {
                    if (item.productId.images && item.productId.images.length > 0) {
                      imageUrl = item.productId.images[0].url;
                    }
                  }
                %>
                <img 
                  src="<%= imageUrl %>" 
                  alt="<%= item && item.productId ? item.productId.name : 'Product' %>"
                  onerror="this.onerror=null; this.src='/placeholder.svg?height=60&width=60&query=fashion+product';"
                >
              </div>
              <div class="item-details">
                <div class="item-name"><%= item && item.productId ? item.productId.name : 'Product' %></div>
                <div class="item-meta">
                  <span>Size: <%= item.size || 'N/A' %></span>
                  <span>Qty: <%= item.quantity || 1 %></span>
                </div>
                
                <% 
                  // Find the corresponding discounted item if available
                  let discountedItem = null;
                  if (discountedItems) {
                    discountedItem = discountedItems.find(di => 
                      di.id && item.productId && di.id.toString() === item.productId._id.toString() && 
                      di.size === item.size
                    );
                  }
                  
                  // Get price information
                  let originalPrice = 0;
                  let discountedPrice = 0;
                  let hasDiscount = false;
                  
                  if (item && item.productId && item.productId.variants) {
                    const variant = item.productId.variants.find(v => v.size === item.size);
                    if (variant && variant.salePrice) {
                      originalPrice = variant.salePrice;
                      
                      // If we have discount information, use it
                      if (discountedItem && discountedItem.discountAmount > 0) {
                        discountedPrice = discountedItem.finalPrice;
                        hasDiscount = true;
                      } else {
                        discountedPrice = originalPrice;
                      }
                    }
                  }
                %>
                
                <% if (hasDiscount) { %>
                  <div class="item-price-container">
                    <span class="item-original-price">₹<%= (originalPrice * item.quantity).toFixed(2) %></span>
                    <span class="item-price">₹<%= (discountedPrice * item.quantity).toFixed(2) %></span>
                    <span class="item-discount-badge">-<%= ((originalPrice - discountedPrice) / originalPrice * 100).toFixed(0) %>%</span>
                  </div>
                <% } else { %>
                  <div class="item-price">₹<%= (originalPrice * item.quantity).toFixed(2) %></div>
                <% } %>
              </div>
            </div>
          <% }); %>
          
          <% if (cartItems.length > 3) { %>
            <div class="more-items">
              <button class="btn-view-all" id="openSidebar">
                View all <%= cartItems.length %> items
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          <% } %>
        </div>
        
        <div class="price-summary">
          <div class="price-row">
            <span>Subtotal</span>
            <span>₹<%= totalPrice.toFixed(2) %></span>
          </div>
          <div class="price-row">
            <span>Delivery</span>
            <span><%= deliveryCharge === 0 ? 'FREE' : '₹' + deliveryCharge.toFixed(2) %></span>
          </div>
          
          <% if (discount > 0 && appliedCoupon) { %>
            <div class="price-row discount">
              <span>
                Discount (<%= appliedCoupon.code %>)
                <% if (appliedCoupon.percent) { %>
                  <span class="discount-percent">-<%= appliedCoupon.percent %>%</span>
                <% } %>
              </span>
              <span>-₹<%= discount.toFixed(2) %></span>
            </div>
          <% } %>
          
          <div class="price-row total">
            <span>Total</span>
            <span>₹<%= grandTotal.toFixed(2) %></span>
          </div>
        </div>
        
        <div class="coupon-section">
          <% if (appliedCoupon) { %>
            <div class="applied-coupon" id="appliedCoupon">
              <div class="coupon-info">
                <i class="fas fa-tag"></i>
                <span><%= appliedCoupon.code %> applied</span>
              </div>
              <button class="btn-remove-coupon" id="removeCouponBtn">
                <i class="fas fa-times"></i>
              </button>
            </div>
          <% } else { %>
            <button class="btn-apply-coupon" id="openCouponSidebar">
              <i class="fas fa-tag"></i>
              Apply Coupon
            </button>
          <% } %>
        </div>
        
        <div class="brand-section">
          <img src="/Uploads/ChatGPT Image Apr 13, 2025, 06_50_48 PM.png" alt="ELITE WEAR Brand" class="brand-logo">
        </div>
      </div>
    </div>
    
    <!-- Delivery Address Section -->
    <div class="col-lg-8 order-lg-1">
      <div class="delivery-card" data-aos="fade-right" data-aos-delay="200">
        <div class="card-header">
          <h5>Select Delivery Address</h5>
          <a href="/getaddAddress" class="btn-add-address">
            <i class="fas fa-plus"></i>
            Add New
          </a>
        </div>
        
        <div class="addresses-container">
          <% if (addresses.length === 0) { %>
            <div class="no-address" data-aos="fade-up" data-aos-delay="300">
              <div class="icon">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <p>You don't have any saved addresses</p>
              <a href="/getaddAddress" class="btn-primary">Add New Address</a>
            </div>
          <% } else { %>
            <div class="row g-3">
              <% addresses.forEach((addr, index) => { %>
                <div class="col-md-6" data-aos="fade-up" data-aos-delay="<%= 300 + (index * 100) %>">
                  <div class="address-card">
                    <div class="shimmer"></div>
                    <div class="address-header">
                      <h6><%= addr.name || addr.fullname %></h6>
                      <a href="/getaddress-edit/<%= addr._id %>" class="btn-edit">
                        <i class="fas fa-pencil-alt"></i>
                      </a>
                    </div>
                    <div class="address-content">
                      <p>
                        <%= addr.address || 'No address' %><br>
                        <% if (addr.landmark) { %><%= addr.landmark %>,<% } %>
                        <%= addr.city || 'N/A' %><br>
                        <%= addr.district || '' %>
                        <%= addr.pincode || 'N/A' %><br>
                        <%= addr.state || 'N/A' %>, <%= addr.country || '' %>
                      </p>
                      <div class="address-type">
                        <span class="badge <%= addr.type === 'home' ? 'bg-info' : 'bg-secondary' %>">
                          <%= addr.type === 'home' ? 'Home' : (addr.type === 'work' ? 'Work' : 'Other') %>
                        </span>
                      </div>
                    </div>
                    <button class="btn-deliver-here address-select-btn" data-address-id="<%= addr._id %>">
                      Deliver Here
                    </button>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Order Summary Sidebar -->
<div class="sidebar-overlay" id="overlay"></div>
<div class="order-summary-sidebar" id="orderSummarySidebar">
  <div class="sidebar-header">
    <h5>Order Summary</h5>
    <button class="btn-close" id="closeSidebar">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="sidebar-content">
    <div class="order-items-list">
      <% cartItems.forEach(item => { %>
        <div class="order-item">
          <div class="item-image">
            <% 
              let imageUrl = '/placeholder.svg?height=60&width=60&query=fashion+product';
              if (item && item.productId) {
                if (item.productId.images && item.productId.images.length > 0) {
                  imageUrl = item.productId.images[0].url;
                }
              }
            %>
            <img 
              src="<%= imageUrl %>" 
              alt="<%= item && item.productId ? item.productId.name : 'Product' %>"
              onerror="this.onerror=null; this.src='/placeholder.svg?height=60&width=60&query=fashion+product';"
            >
          </div>
          <div class="item-details">
            <div class="item-name"><%= item && item.productId ? item.productId.name : 'Product' %></div>
            <div class="item-meta">
              <span>Size: <%= item.size || 'N/A' %></span>
              <span>Qty: <%= item.quantity || 1 %></span>
            </div>
            
            <% 
              // Find the corresponding discounted item if available
              let discountedItem = null;
              if (discountedItems) {
                discountedItem = discountedItems.find(di => 
                  di.id && item.productId && di.id.toString() === item.productId._id.toString() && 
                  di.size === item.size
                );
              }
              
              // Get price information
              let originalPrice = 0;
              let discountedPrice = 0;
              let hasDiscount = false;
              
              if (item && item.productId && item.productId.variants) {
                const variant = item.productId.variants.find(v => v.size === item.size);
                if (variant && variant.salePrice) {
                  originalPrice = variant.salePrice;
                  
                  // If we have discount information, use it
                  if (discountedItem && discountedItem.discountAmount > 0) {
                    discountedPrice = discountedItem.finalPrice;
                    hasDiscount = true;
                  } else {
                    discountedPrice = originalPrice;
                  }
                }
              }
            %>
            
            <% if (hasDiscount) { %>
              <div class="item-price-container">
                <span class="item-original-price">₹<%= (originalPrice * item.quantity).toFixed(2) %></span>
                <span class="item-price">₹<%= (discountedPrice * item.quantity).toFixed(2) %></span>
                <span class="item-discount-badge">-<%= ((originalPrice - discountedPrice) / originalPrice * 100).toFixed(0) %>%</span>
              </div>
            <% } else { %>
              <div class="item-price">₹<%= (originalPrice * item.quantity).toFixed(2) %></div>
            <% } %>
          </div>
        </div>
      <% }); %>
    </div>
    
    <div class="price-summary">
      <div class="price-row">
        <span>Subtotal</span>
        <span>₹<%= totalPrice.toFixed(2) %></span>
      </div>
      <div class="price-row">
        <span>Delivery</span>
        <span><%= deliveryCharge === 0 ? 'FREE' : '₹' + deliveryCharge.toFixed(2) %></span>
      </div>
      
      <% if (discount > 0 && appliedCoupon) { %>
        <div class="price-row discount">
          <span>
            Discount (<%= appliedCoupon.code %>)
            <% if (appliedCoupon.percent) { %>
              <span class="discount-percent">-<%= appliedCoupon.percent %>%</span>
            <% } %>
          </span>
          <span>-₹<%= discount.toFixed(2) %></span>
        </div>
      <% } %>
      
      <div class="price-row total">
        <span>Total</span>
        <span>₹<%= grandTotal.toFixed(2) %></span>
      </div>
    </div>
  </div>
</div>

<!-- Coupon Sidebar -->
<div class="coupon-overlay" id="couponOverlay"></div>
<div class="coupon-sidebar" id="couponSidebar">
  <div class="sidebar-header">
    <h5>Apply Coupon</h5>
    <button class="btn-close" id="closeCouponSidebar">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="sidebar-content">
    <div class="coupon-input-group">
      <input type="text" placeholder="Enter coupon code" id="couponCodeInput">
      <button class="btn-apply" id="applyCouponBtn">Apply</button>
    </div>
    <div id="couponError" class="coupon-error"></div>
    
    <div class="coupon-categories">
      <div class="coupon-category">
        <h6>Available Coupons</h6>
        <div id="availableCoupons" class="coupon-list"></div>
      </div>
      
      <div class="coupon-category">
        <h6>Used Coupons</h6>
        <div id="usedCoupons" class="coupon-list"></div>
      </div>
      
      <div class="coupon-category">
        <h6>Expired Coupons</h6>
        <div id="expiredCoupons" class="coupon-list"></div>
      </div>
      
      <div class="coupon-category">
        <h6>Upcoming Coupons</h6>
        <div id="upcomingCoupons" class="coupon-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>

<%- include("../partials/user/footer") %>

<!-- Dark Mode Toggle -->
<button class="dark-mode-toggle" id="darkModeToggle">
  <i class="fas fa-moon"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize AOS
    AOS.init({
      duration: 800,
      easing: 'ease-in-out',
      once: true
    });



    // Scroll Indicator
    const scrollIndicator = document.querySelector('.scroll-indicator');
    window.addEventListener('scroll', () => {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      scrollIndicator.style.width = scrolled + '%';
    });

    // Cursor Glow Effect
    const cursorGlow = document.querySelector('.cursor-glow');
    document.addEventListener('mousemove', (e) => {
      cursorGlow.style.left = e.clientX + 'px';
      cursorGlow.style.top = e.clientY + 'px';
    });

    document.addEventListener('mousedown', () => {
      cursorGlow.style.width = '30px';
      cursorGlow.style.height = '30px';
      cursorGlow.style.opacity = '0.8';
    });

    document.addEventListener('mouseup', () => {
      cursorGlow.style.width = '20px';
      cursorGlow.style.height = '20px';
      cursorGlow.style.opacity = '0.5';
    });

    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    
    // Check for saved theme preference or use the system preference
    const savedTheme = localStorage.getItem('theme');
    
    if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme.matches)) {
      document.body.classList.add('dark-mode');
      darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    
    darkModeToggle.addEventListener('click', () => {
      if (document.body.classList.contains('dark-mode')) {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      } else {
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }
    });

    // Navbar scroll effect
    window.addEventListener('scroll', function () {
      const navbar = document.querySelector('.navbar');
      if (navbar) {
        if (window.scrollY > 50) {
          navbar.classList.add('navbar-scrolled');
        } else {
          navbar.classList.remove('navbar-scrolled');
        }
      }
    });

    // Add shimmer effect to address cards
    document.querySelectorAll('.address-card').forEach(card => {
      card.addEventListener('mouseenter', () => {
        const shimmer = card.querySelector('.shimmer');
        if (shimmer) {
          shimmer.style.opacity = '1';
        }
      });

      card.addEventListener('mouseleave', () => {
        const shimmer = card.querySelector('.shimmer');
        if (shimmer) {
          shimmer.style.opacity = '0';
        }
      });
    });


    window.totalPrice = Number.parseFloat(
      document.querySelector(".price-row:first-child").lastElementChild.textContent.replace("₹", "")
    );

    // Order Summary Sidebar
    const openSidebar = document.getElementById("openSidebar");
    const closeSidebar = document.getElementById("closeSidebar");
    const sidebar = document.getElementById("orderSummarySidebar");
    const overlay = document.getElementById("overlay");

    if (openSidebar && sidebar && overlay) {
      openSidebar.addEventListener("click", () => {
        sidebar.classList.add("active");
        overlay.classList.add("active");
        document.body.style.overflow = "hidden";
      });
    }

    if (closeSidebar && sidebar && overlay) {
      closeSidebar.addEventListener("click", () => {
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
        document.body.style.overflow = "auto";
      });
    }

    if (overlay && sidebar) {
      overlay.addEventListener("click", () => {
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
        document.body.style.overflow = "auto";
      });
    }

    // Coupon Sidebar
    const openCouponSidebar = document.getElementById("openCouponSidebar");
    const closeCouponSidebar = document.getElementById("closeCouponSidebar");
    const couponSidebar = document.getElementById("couponSidebar");
    const couponOverlay = document.getElementById("couponOverlay");

    if (openCouponSidebar && couponSidebar && couponOverlay) {
      openCouponSidebar.addEventListener("click", () => {
        couponSidebar.classList.add("active");
        couponOverlay.classList.add("active");
        document.body.style.overflow = "hidden";
        fetchCoupons();
      });
    }

    if (closeCouponSidebar && couponSidebar && couponOverlay) {
      closeCouponSidebar.addEventListener("click", () => {
        couponSidebar.classList.remove("active");
        couponOverlay.classList.remove("active");
        document.body.style.overflow = "auto";
      });
    }

    if (couponOverlay && couponSidebar) {
      couponOverlay.addEventListener("click", () => {
        couponSidebar.classList.remove("active");
        couponOverlay.classList.remove("active");
        document.body.style.overflow = "auto";
      });
    }

    // Apply coupon button
    const applyCouponBtn = document.getElementById("applyCouponBtn");
    if (applyCouponBtn) {
      applyCouponBtn.addEventListener("click", () => {
        applyCoupon();
      });
    }

    // Remove coupon button
    const removeCouponBtn = document.getElementById("removeCouponBtn");
    if (removeCouponBtn) {
      removeCouponBtn.addEventListener("click", () => {
        removeCoupon();
      });
    }

    // Address selection buttons
    const addressButtons = document.querySelectorAll(".address-select-btn");
    addressButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const addressId = this.getAttribute("data-address-id");
        selectAddress(addressId);
      });
    });

    // Initialize toast system
    window.toastSystem = {
      container: document.getElementById("toastContainer"),
      counter: 0,

      // Show a toast notification
      show: function (message, type = "success", duration = 3000) {
        try {
          // Create toast element
          const toastId = `toast-${++this.counter}`;
          const toast = document.createElement("div");
          toast.id = toastId;
          toast.className = `toast-notification ${type}`;

          // Set icon based on type
          let icon = "";
          if (type === "success") {
            icon = '<i class="fas fa-check-circle"></i>';
          } else if (type === "error") {
            icon = '<i class="fas fa-exclamation-circle"></i>';
          } else if (type === "info") {
            icon = '<i class="fas fa-info-circle"></i>';
          }

          // Create toast content
          toast.innerHTML = `
            <div class="toast-icon">${icon}</div>
            <div class="toast-message">${message}</div>
            <button class="toast-close" aria-label="Close">×</button>
            <div class="toast-progress"></div>
          `;

          // Add to container
          this.container.appendChild(toast);

          // Add close button functionality
          const closeBtn = toast.querySelector(".toast-close");
          closeBtn.addEventListener("click", () => {
            this.close(toastId);
          });

          // Auto close after duration
          setTimeout(() => {
            this.close(toastId);
          }, duration);

          return toastId;
        } catch (error) {
          console.error("Error showing toast:", error);
          // Fallback to alert if toast fails
          alert(message);
        }
      },

      // Close a toast notification
      close: (id) => {
        try {
          const toast = document.getElementById(id);
          if (toast) {
            toast.style.animation = "slideOut 0.3s forwards";
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 300);
          }
        } catch (error) {
          console.error("Error closing toast:", error);
        }
      },

      // Helper methods for different toast types
      success: function (message, duration) {
        return this.show(message, "success", duration);
      },

      error: function (message, duration) {
        return this.show(message, "error", duration);
      },

      info: function (message, duration) {
        return this.show(message, "info", duration);
      },
    };
  });

  // Fetch coupons function
  async function fetchCoupons() {
try {
  // Show loading indicator in each coupon container
  document.getElementById("availableCoupons").innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Loading coupons...</div>';
  document.getElementById("usedCoupons").innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i></div>';
  document.getElementById("expiredCoupons").innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i></div>';
  document.getElementById("upcomingCoupons").innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i></div>';
  
  // Use the correct endpoint from your router.js
  const response = await fetch("/coupons");
  
  if (!response.ok) {
    throw new Error(`Server responded with status: ${response.status}`);
  }
  
  const result = await response.json();
  console.log("Fetched coupons:", result);

  if (result.success && result.coupons && Array.isArray(result.coupons)) {
    renderCouponsByCategory(result.coupons);
    document.getElementById("couponError").style.display = "none";
  } else {
    throw new Error("Invalid coupon data format");
  }
} catch (error) {
  console.error("Error fetching coupons:", error);
  
  // Try to use server-rendered coupons if available
  if (window.serverCoupons && Array.isArray(window.serverCoupons) && window.serverCoupons.length > 0) {
    console.log("Using server-rendered coupons:", window.serverCoupons);
    renderCouponsByCategory(window.serverCoupons);
  } else {
    // Show error message
    const couponError = document.getElementById("couponError");
    couponError.textContent = "Unable to load coupons. Please try again later.";
    couponError.style.display = "block";
    
    // Show empty state in each container
    document.getElementById("availableCoupons").innerHTML = '<div class="empty-coupon-message">No coupons available</div>';
    document.getElementById("usedCoupons").innerHTML = '<div class="empty-coupon-message">No used coupons</div>';
    document.getElementById("expiredCoupons").innerHTML = '<div class="empty-coupon-message">No expired coupons</div>';
    document.getElementById("upcomingCoupons").innerHTML = '<div class="empty-coupon-message">No upcoming coupons</div>';
  }
}
}

// In the renderCouponsByCategory function, add validation to filter out dummy/invalid coupons
// Replace the existing renderCouponsByCategory function with this improved version:

function renderCouponsByCategory(coupons) {
  console.log("Rendering coupons:", coupons);
  
  // Get container elements for each category
  const availableContainer = document.getElementById("availableCoupons");
  const usedContainer = document.getElementById("usedCoupons");
  const expiredContainer = document.getElementById("expiredCoupons");
  const upcomingContainer = document.getElementById("upcomingCoupons");

  // Clear all containers
  availableContainer.innerHTML = "";
  usedContainer.innerHTML = "";
  expiredContainer.innerHTML = "";
  upcomingContainer.innerHTML = "";

  if (!coupons || coupons.length === 0) {
    availableContainer.innerHTML = '<div class="empty-coupon-message">No coupons available</div>';
    usedContainer.innerHTML = '<div class="empty-coupon-message">No used coupons</div>';
    expiredContainer.innerHTML = '<div class="empty-coupon-message">No expired coupons</div>';
    upcomingContainer.innerHTML = '<div class="empty-coupon-message">No upcoming coupons</div>';
    return;
  }

  // Sort coupons into categories
  const available = [];
  const used = [];
  const expired = [];
  const upcoming = [];

  const now = new Date();

  coupons.forEach((coupon) => {
    // Normalize coupon data structure
    const normalizedCoupon = {
      id: coupon._id || coupon.id,
      code: coupon.coupencode || coupon.code,
      percent: coupon.couponpercent || coupon.percent || coupon.discountPercent || 0,
      minimumPurchase: coupon.minimumPurchase || 0,
      startingDate: coupon.startingDate || coupon.startDate,
      expiryDate: coupon.expiryDate,
      limit: coupon.limit || 1,
      userUsageCount: coupon.userUsageCount || coupon.usedCount || 0,
      description: coupon.description || "",
      status: coupon.status || "available"
    };
    
    // Skip invalid or dummy coupons (those with 0% discount or missing essential data)
    if (!normalizedCoupon.code || normalizedCoupon.percent <= 0) {
      console.log("Skipping invalid coupon:", normalizedCoupon);
      return; // Skip this coupon
    }
    
    // If status is not explicitly set, determine it based on dates
    if (!coupon.status) {
      const startDate = new Date(normalizedCoupon.startingDate);
      const expiryDate = new Date(normalizedCoupon.expiryDate);
      
      if (now < startDate) {
        normalizedCoupon.status = "upcoming";
      } else if (now > expiryDate) {
        normalizedCoupon.status = "expired";
      } else if (normalizedCoupon.userUsageCount >= normalizedCoupon.limit) {
        normalizedCoupon.status = "used";
      } else {
        normalizedCoupon.status = "available";
      }
    }

    // Add to appropriate category
    if (normalizedCoupon.status === "used") {
      used.push(normalizedCoupon);
    } else if (normalizedCoupon.status === "expired") {
      expired.push(normalizedCoupon);
    } else if (normalizedCoupon.status === "upcoming") {
      upcoming.push(normalizedCoupon);
    } else {
      available.push(normalizedCoupon);
    }
  });

  console.log("Categorized coupons:", { available, used, expired, upcoming });

  // Render each category
  if (available.length > 0) {
    available.forEach((coupon) => {
      availableContainer.appendChild(createCouponElement(coupon));
    });
  } else {
    availableContainer.innerHTML = '<div class="empty-coupon-message">No available coupons</div>';
  }

  if (used.length > 0) {
    used.forEach((coupon) => {
      usedContainer.appendChild(createCouponElement(coupon));
    });
  } else {
    usedContainer.innerHTML = '<div class="empty-coupon-message">No used coupons</div>';
  }

  if (expired.length > 0) {
    expired.forEach((coupon) => {
      expiredContainer.appendChild(createCouponElement(coupon));
    });
  } else {
    expiredContainer.innerHTML = '<div class="empty-coupon-message">No expired coupons</div>';
  }

  if (upcoming.length > 0) {
    upcoming.forEach((coupon) => {
      upcomingContainer.appendChild(createCouponElement(coupon));
    });
  } else {
    upcomingContainer.innerHTML = '<div class="empty-coupon-message">No upcoming coupons</div>';
  }
}

// Also update the createCouponElement function to handle date formatting better
function createCouponElement(coupon) {
  console.log("Creating coupon element for:", coupon);
  
  const couponItem = document.createElement("div");
  couponItem.className = "coupon-item";

  // Format dates
  let startDate = "N/A";
  let expiryDate = "N/A";
  
  try {
    if (coupon.startingDate) {
      const date = new Date(coupon.startingDate);
      if (!isNaN(date.getTime())) {
        startDate = date.toLocaleDateString();
      }
    }
    if (coupon.expiryDate) {
      const date = new Date(coupon.expiryDate);
      if (!isNaN(date.getTime())) {
        expiryDate = date.toLocaleDateString();
      }
    }
  } catch (e) {
    console.error("Error formatting dates:", e);
  }

  // Determine if eligible based on minimum purchase
  const isEligible = (coupon.minimumPurchase || 0) <= window.totalPrice;

  // Create usage info
  let usageInfo = "";
  if (coupon.status === "used") {
    usageInfo = `<div class="coupon-usage">Used ${coupon.userUsageCount || 1}/${coupon.limit || 1} times</div>`;
  } else if (coupon.status === "available") {
    if ((coupon.limit || 1) > 1) {
      const remainingUses = (coupon.limit || 1) - (coupon.userUsageCount || 0);
      usageInfo = `<div class="coupon-usage">Can be used ${remainingUses} more time(s)</div>`;
    }
  }

  // Create tooltip for ineligible coupons
  let tooltipHtml = "";
  if (coupon.status === "available" && !isEligible) {
    const amountNeeded = ((coupon.minimumPurchase || 0) - window.totalPrice).toFixed(2);
    tooltipHtml = `
      <div class="coupon-tooltip">
        <i class="fas fa-info-circle"></i>
        <span class="tooltip-text">Add ₹${amountNeeded} more to your cart to use this coupon</span>
      </div>
    `;
  }

  // Get status text
  let statusText = "";
  if (coupon.status === "available") {
    statusText = "Available";
  } else if (coupon.status === "used") {
    statusText = "Used";
  } else if (coupon.status === "expired") {
    statusText = "Expired";
  } else if (coupon.status === "upcoming") {
    statusText = "Upcoming";
  }

  // Get coupon code and percent
  const couponCode = coupon.code || "";
  const couponPercent = coupon.percent || 0;

  couponItem.innerHTML = `
    <div class="coupon-code">${couponCode} ${tooltipHtml}</div>
    <div class="coupon-status status-${coupon.status}">${statusText}</div>
    <div class="coupon-offer">${couponPercent}% off entire order</div>
    <div class="coupon-min-purchase">Minimum purchase: ₹${(coupon.minimumPurchase || 0).toFixed(2)}</div>
    <div class="coupon-expiry">Valid: ${startDate} to ${expiryDate}</div>
    ${usageInfo}
    ${coupon.description ? `<div class="coupon-description">${coupon.description}</div>` : ""}
    ${
      coupon.status === "available"
        ? `<button class="coupon-apply-btn" onclick="applyCouponCode('${couponCode}')" 
            ${!isEligible ? "disabled" : ""}>
            ${isEligible ? "APPLY" : "NOT ELIGIBLE"}
        </button>`
        : ""
    }
  `;

  return couponItem;
}

  // Apply coupon from input field
  async function applyCoupon() {
    const couponCode = document.getElementById("couponCodeInput").value.trim();
    applyCouponCode(couponCode);
  }

  // Apply coupon with code
  async function applyCouponCode(couponCode) {
    try {
      if (!couponCode) {
        showToast("Please enter a coupon code", "error");
        return;
      }

      // Show loading state
      const applyBtn = document.querySelector(".btn-apply");
      if (applyBtn) {
        applyBtn.disabled = true;
        applyBtn.textContent = "Applying...";
      }

      const response = await fetch("/apply-coupon", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ couponCode }),
      });

      const result = await response.json();

      if (result.success) {
        // Create confetti animation
        createConfetti();
        
        showToast(`Coupon "${couponCode}" applied successfully!`, "success");

        // Close the coupon sidebar
        const couponSidebar = document.getElementById("couponSidebar");
        const couponOverlay = document.getElementById("couponOverlay");
        if (couponSidebar && couponOverlay) {
          couponSidebar.classList.remove("active");
          couponOverlay.classList.remove("active");
          document.body.style.overflow = "auto";
        }

        // Reload the page after a short delay to show the toast
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        showToast(result.message || "Failed to apply coupon", "error");
      }
    } catch (error) {
      console.error("Error applying coupon:", error);
      showToast("Error applying coupon. Please try again.", "error");
    } finally {
      // Reset loading state
      const applyBtn = document.querySelector(".btn-apply");
      if (applyBtn) {
        applyBtn.disabled = false;
        applyBtn.textContent = "Apply";
      }
    }
  }

  // Create confetti animation
  function createConfetti() {
    const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#10b981', '#f59e0b'];
    const confettiCount = 100;
    
    for (let i = 0; i < confettiCount; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.width = Math.random() * 10 + 5 + 'px';
      confetti.style.height = Math.random() * 10 + 5 + 'px';
      confetti.style.opacity = Math.random();
      confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
      document.body.appendChild(confetti);
      
      // Remove confetti after animation completes
      setTimeout(() => {
        confetti.remove();
      }, 5000);
    }
  }

  // Remove coupon
  async function removeCoupon() {
    try {
      // Add animation to the applied coupon element
      const appliedCoupon = document.getElementById('appliedCoupon');
      if (appliedCoupon) {
        appliedCoupon.style.animation = 'slideOut 0.3s forwards';
      }
      
      const response = await fetch("/remove-coupon", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      const result = await response.json();

      if (result.success) {
        showToast("Coupon removed successfully!", "info");

        // Reload the page after a short delay to show the toast
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        showToast(result.message || "Failed to remove coupon", "error");
      }
    } catch (error) {
      console.error("Error removing coupon:", error);
      showToast("Server error while removing coupon", "error");
    }
  }

  // Select address
  function selectAddress(addressId) {
    // Show loading state on the button
    const button = document.querySelector(`.address-select-btn[data-address-id="${addressId}"]`);
    if (button) {
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    }

    fetch("/select-delivery-address", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ addressId }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showToast("Address selected successfully!", "success");
          setTimeout(() => {
            window.location.href = "/checkout-payment";
          }, 1000);
        } else {
          showToast(data.message || "Failed to select address", "error");
          // Reset button state
          if (button) {
            button.disabled = false;
            button.textContent = "DELIVER HERE";
          }
        }
      })
      .catch((error) => {
        console.error("Error selecting address:", error);
        showToast("Server issue while selecting address", "error");
        // Reset button state
        if (button) {
          button.disabled = false;
          button.textContent = "DELIVER HERE";
        }
      });
  }

  // Helper function to show toast
  function showToast(message, type = "success", duration = 3000) {
    if (window.toastSystem) {
      return window.toastSystem.show(message, type, duration);
    } else {
      // Create a simple toast if the toast system is not available
      const toast = document.createElement("div");
      toast.className = `toast-notification ${type}`;
      toast.innerHTML = `
        <div class="toast-message">${message}</div>
      `;

      const container = document.getElementById("toastContainer");
      if (container) {
        container.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, duration);
      } else {
        alert(message);
      }
    }
  }

  // Initialize coupons from EJS if available
  window.addEventListener('DOMContentLoaded', function() {
    // Store coupons from EJS template if available
    if (typeof coupons !== 'undefined' && Array.isArray(coupons)) {
      window.ejsCoupons = coupons;
    }
  });
</script>
// Add this script at the end of the file, just before the closing </body> tag
// Initialize server coupons data
window.serverCoupons = <%- JSON.stringify(coupons || []) %>;
console.log("Server coupons initialized:", window.serverCoupons);
</body>
</html>
