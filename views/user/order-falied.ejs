<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Failed - ELITE WEAR</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
    <link rel="stylesheet" href="/userStyle/order-failed.css">
</head>
<body>
    <%- include("../partials/user/header") %>

 
    <div class="toast-container">
        <div class="toast custom-toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="toast-header">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                <strong class="me-auto">Payment Failed</strong>
                <small>Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <p class="mb-0">Your payment for order #<%= order.orderNumber %> was not successful. Please try again.</p>
            </div>
        </div>
    </div>

    <!-- Sound control button -->
    <div class="sound-control" id="soundControl" title="Play alert sound">
        <i class="fas fa-volume-up"></i>
    </div>

    <!-- Lightning effect container -->
    <div class="lightning" id="lightning"></div>

    <!-- Main content -->
    <div class="failure-container">
        <div class="failure-header" data-aos="fade-down">
            <div class="error-circle">
                <div class="background"></div>
                <div class="error-x">×</div>
            </div>
            <h1 class="failure-title">Payment Failed!</h1>
            <p class="failure-subtitle">
                We couldn't process your payment. Don't worry, your order is saved and you can try again.
            </p>
        </div>

        <div class="row">
            <!-- Order details -->
            <div class="col-lg-7" data-aos="fade-right" data-aos-delay="200">
                <div class="retry-payment-container" data-aos="fade-up" data-aos-delay="300">
                    <div class="retry-payment-header">
                        <div class="retry-payment-icon">
                            <i class="fas fa-redo-alt"></i>
                        </div>
                        <h3 class="retry-payment-title">Retry Payment</h3>
                    </div>
                    <p class="retry-payment-description">
                        Your order is saved but the payment was not successful. You can retry payment now or later from your orders page.
                    </p>
                    <div class="payment-options">
                        <div class="payment-option active" data-payment="razorpay">
                            <div class="payment-option-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="payment-option-label">Credit/Debit Card</div>
                        </div>
                        <div class="payment-option" data-payment="upi">
                            <div class="payment-option-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="payment-option-label">UPI</div>
                        </div>
                        <div class="payment-option" data-payment="netbanking">
                            <div class="payment-option-icon">
                                <i class="fas fa-university"></i>
                            </div>
                            <div class="payment-option-label">Net Banking</div>
                        </div>
                        <div class="payment-option" data-payment="wallet">
                            <div class="payment-option-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="payment-option-label">Wallet</div>
                        </div>
                    </div>
                    <a href="/checkout-payment" class="btn btn-primary-action btn-action w-100" id="retryPaymentBtn">
                        <i class="fas fa-redo-alt me-2"></i>Retry Payment Now
                    </a>
                </div>

                <div class="order-card shimmer">
                    <div class="failure-badge" id="failureBadge">
                        <i class="fas fa-exclamation"></i>
                    </div>
                    <div class="order-card-header">
                        <h3>Order #<%= order.orderNumber %></h3>
                        <p class="mb-0">Placed on <%= order.orderDate.toLocaleString('en-IN', { dateStyle: 'full', timeStyle: 'short' }) %></p>
                    </div>
                    <div class="order-card-body">
                        <div class="order-detail-row">
                            <div class="order-detail-label">
                                <i class="fas fa-user me-2"></i> Customer
                            </div>
                            <div class="order-detail-value"><%= user.fullname || 'N/A' %></div>
                        </div>
                        
                        <div class="order-detail-row">
                            <div class="order-detail-label">
                                <i class="fas fa-envelope me-2"></i> Email
                            </div>
                            <div class="order-detail-value"><%= user.email || 'N/A' %></div>
                        </div>
                        
                        <div class="order-detail-row">
                            <div class="order-detail-label">
                                <i class="fas fa-phone me-2"></i> Phone
                            </div>
                            <div class="order-detail-value"><%= user.mobile || (order.address && order.address.mobile) || 'N/A' %></div>
                        </div>
                        
                        <div class="order-detail-row">
                            <div class="order-detail-label">
                                <i class="fas fa-map-marker-alt me-2"></i> Shipping Address
                            </div>
                            <div class="order-detail-value">
                                <% if (order.address) { %>
                                    <%= order.address.fullname %><br>
                                    <%= order.address.address %><br>
                                    <%= order.address.city %>, <%= order.address.district %><br>
                                    <%= order.address.state %> - <%= order.address.pincode %>
                                <% } else { %>
                                    Address information not available
                                <% } %>
                            </div>
                        </div>
                        
                        <div class="order-detail-row">
                            <div class="order-detail-label">
                                <i class="fas fa-credit-card me-2"></i> Payment Method
                            </div>
                            <div class="order-detail-value">
                                <%= order.paymentMethod %>
                                <span class="badge bg-danger ms-2">
                                    <i class="fas fa-times-circle me-1"></i> Failed
                                </span>
                            </div>
                        </div>
                        
                        <div class="order-detail-row">
                            <div class="order-detail-label">
                                <i class="fas fa-shopping-bag me-2"></i> Items
                            </div>
                            <div class="order-detail-value">
                                <%= order.order_items.length %> item<%= order.order_items.length > 1 ? 's' : '' %>
                            </div>
                        </div>
                        
                        <div class="order-detail-row">
                            <div class="order-detail-label">
                                <i class="fas fa-tag me-2"></i> Subtotal
                            </div>
                            <div class="order-detail-value">
                                ₹<%= ((order.total || 0) - ((order.total || 0) > 8000 ? 0 : 200) + (order.discount || 0)).toFixed(2) %>
                            </div>
                        </div>
                        
                        <div class="order-detail-row">
                            <div class="order-detail-label">
                                <i class="fas fa-truck me-2"></i> Shipping
                            </div>
                            <div class="order-detail-value">
                                <% if ((order.total || 0) > 8000) { %>
                                    <span class="text-success">Free</span>
                                <% } else { %>
                                    ₹200.00
                                <% } %>
                            </div>
                        </div>
                        
                        <% if (order.discount > 0) { %>
                            <div class="order-detail-row">
                                <div class="order-detail-label">
                                    <i class="fas fa-percent me-2"></i> Discount
                                </div>
                                <div class="order-detail-value text-success">
                                    -₹<%= order.discount.toFixed(2) %>
                                </div>
                            </div>
                        <% } %>
                        
                        <div class="order-detail-row total-row">
                            <div class="order-detail-label">
                                <i class="fas fa-money-bill-wave me-2"></i> Total
                            </div>
                            <div class="order-detail-value">
                                ₹<%= (order.total || 0).toFixed(2) %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order status -->
                <div class="tracking-progress" data-aos="fade-up" data-aos-delay="400">
                    <h4 class="fw-bold mb-3">Order Status</h4>
                    <div class="tracking-steps">
                        <div class="tracking-step step-active">
                            <div class="step-icon">
                                <i class="fas fa-exclamation"></i>
                            </div>
                            <div class="step-label">Payment Failed</div>
                        </div>
                        <div class="tracking-step">
                            <div class="step-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="step-label">Confirmed</div>
                        </div>
                        <div class="tracking-step">
                            <div class="step-icon">
                                <i class="fas fa-shipping-fast"></i>
                            </div>
                            <div class="step-label">Shipped</div>
                        </div>
                        <div class="tracking-step">
                            <div class="step-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="step-label">Delivered</div>
                        </div>
                    </div>
                    <div class="estimated-delivery">
                        <span class="text-danger">Your order will be processed after successful payment</span>
                    </div>
                </div>
            </div>

            <!-- Order summary and actions -->
            <div class="col-lg-5" data-aos="fade-left" data-aos-delay="300">
                <div class="order-illustration">
                    <img 
                       src="/Uploads/payment_success.png" 
                        alt="Payment Failed" 
                        class="img-fluid" 
                        onerror="this.src='/Uploads/placeholder.jpg'"
                    />
                </div>

                <!-- Order items summary -->
                <div class="order-card mb-4">
                    <div class="order-card-header">
                        <h3>Order Items</h3>
                    </div>
                    <div class="order-card-body p-0">
                        <div class="list-group list-group-flush">
                            <% order.order_items.forEach(item => { %>
                                <div class="list-group-item d-flex align-items-center p-3">
                                    <div class="flex-shrink-0 me-3">
                                        <% if (item.itemImage || (item.productId && item.productId.images && item.productId.images.length > 0)) { %>
                                            <img 
                                                src="<%= item.itemImage || (item.productId.images[0].url) %>" 
                                                alt="<%= item.product_name %>" 
                                                class="rounded" 
                                                width="60"
                                                height="60"
                                                style="object-fit: cover;"
                                            >
                                        <% } else { %>
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-tshirt text-muted"></i>
                                            </div>
                                        <% } %>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 fw-bold">
                                            <%= item.product_name || 'Unnamed Product' %>
                                        </h6>
                                        <p class="mb-0 small text-muted">
                                            Size: <%= item.size || 'N/A' %> | Qty: <%= item.quantity || 1 %>
                                        </p>
                                    </div>
                                    <div class="flex-shrink-0 ms-3 text-end">
                                        <span class="fw-bold">₹<%= (item.price !== undefined ? item.price.toFixed(2) : '0.00') %></span>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>

                <!-- Action buttons -->
                <div class="action-buttons">
                    <a href="/checkout-payment" class="btn btn-primary-action btn-action w-100 mb-3 shake" data-aos="fade-up" data-aos-delay="500">
                        <i class="fas fa-redo-alt me-2"></i>Retry Payment
                    </a>
                    <a href="/orders" class="btn btn-secondary-action btn-action w-100 mb-3" data-aos="fade-up" data-aos-delay="600">
                        <i class="fas fa-history me-2"></i>View All Orders
                    </a>
                    <a href="/" class="btn btn-secondary-action btn-action w-100 mb-3" data-aos="fade-up" data-aos-delay="700">
                        <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
                    </a>
                </div>

                <!-- Customer support -->
                <div class="mt-4 p-3 bg-white rounded-3 shadow-sm" data-aos="fade-up" data-aos-delay="800">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="fas fa-headset text-white"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">Need Help?</h6>
                            <p class="mb-0 small">
                                Having trouble with your payment? Contact our customer support at <a href="mailto:support@elitewear.com">support@elitewear.com</a> or call us at <strong>+91 1234567890</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include("../partials/user/footer") %>

    <!-- Hidden audio element for alert sound -->
    <audio id="alertSound" preload="auto">
        <source src="/Uploads/alert-sound.mp3" type="audio/mpeg">
        <!-- Fallback alert sound -->
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Initialize AOS animation library
        document.addEventListener('DOMContentLoaded', function() {
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true,
                disable: window.innerWidth < 768 ? 'phone' : false // Disable animations on small screens for better performance
            });
            
            // Show toast notification
            const toastEl = document.querySelector('.toast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            
            // Play alert sound
            playAlertSound();
            
            // Add event listeners
            setupEventListeners();
            
            // Create lightning effect
            createLightningEffect();
            
            // Check for viewport changes
            window.addEventListener('resize', function() {
                if (window.innerWidth < 768) {
                    AOS.init({disable: 'phone'});
                }
            });
        });
        
        // Play alert sound
        function playAlertSound() {
            const audio = document.getElementById('alertSound');
            
            // Check if browser supports audio
            if (audio) {
                // Try to play with user interaction to avoid autoplay restrictions
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Audio playback was prevented by the browser. Will play on user interaction.');
                    });
                }
            }
        }
        
        // Create lightning effect
        function createLightningEffect() {
            const lightning = document.getElementById('lightning');
            
            // Initial flash
            setTimeout(() => {
                flashLightning();
            }, 1000);
            
            // Periodic flashes
            setInterval(() => {
                flashLightning();
            }, 8000);
        }
        
        function flashLightning() {
            const lightning = document.getElementById('lightning');
            lightning.style.opacity = '0.1';
            
            setTimeout(() => {
                lightning.style.opacity = '0.3';
                
                setTimeout(() => {
                    lightning.style.opacity = '0.1';
                    
                    setTimeout(() => {
                        lightning.style.opacity = '0';
                    }, 100);
                }, 100);
            }, 100);
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Sound control button
            const soundControl = document.getElementById('soundControl');
            if (soundControl) {
                soundControl.addEventListener('click', function() {
                    playAlertSound();
                    
                    // Add animation
                    this.classList.add('animate__animated', 'animate__heartBeat');
                    setTimeout(() => {
                        this.classList.remove('animate__animated', 'animate__heartBeat');
                    }, 1000);
                });
            }
            
            // Failure badge click effect
            const failureBadge = document.getElementById('failureBadge');
            if (failureBadge) {
                failureBadge.addEventListener('click', function() {
                    this.classList.add('shake');
                    setTimeout(() => {
                        this.classList.remove('shake');
                    }, 800);
                });
            }
            
            // Payment options
            const paymentOptions = document.querySelectorAll('.payment-option');
            paymentOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    paymentOptions.forEach(opt => opt.classList.remove('active'));
                    
                    // Add active class to clicked option
                    this.classList.add('active');
                    
                    // Update retry payment button with selected payment method
                    const paymentMethod = this.getAttribute('data-payment');
                    const retryBtn = document.getElementById('retryPaymentBtn');
                    
                    if (retryBtn) {
                        retryBtn.href = `/checkout-payment?method=${paymentMethod}`;
                    }
                });
            });
            
            // Make sure all images are loaded properly
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                img.addEventListener('error', function() {
                    this.src = '/Uploads/placeholder.jpg';
                });
            });
            
            // Add shake animation to retry payment button periodically
            const retryBtn = document.querySelector('.btn-primary-action');
            if (retryBtn) {
                setInterval(() => {
                    retryBtn.classList.add('shake');
                    setTimeout(() => {
                        retryBtn.classList.remove('shake');
                    }, 800);
                }, 5000);
            }
        }
    </script>
</body>
</html>