<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Failed - ELITE WEAR</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
    <link rel="stylesheet" href="/userStyle/order-failed.css">
</head>
<body>
    <%- include("../partials/user/header") %>

    <!-- Toast notification -->
    <div class="toast-container">
        <div class="toast custom-toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="toast-header">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                <strong class="me-auto">Payment Failed</strong>
                <small>Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <p class="mb-0">Your payment was not successful. Please try again to complete your purchase.</p>
            </div>
        </div>
    </div>

    <!-- Sound control button -->
    <div class="sound-control" id="soundControl" title="Play alert sound">
        <i class="fas fa-volume-up"></i>
    </div>

    <!-- Lightning effect container -->
    <div class="lightning" id="lightning"></div>

    <!-- Animated background elements -->
    <div class="animated-bg">
        <div class="animated-shape shape1"></div>
        <div class="animated-shape shape2"></div>
        <div class="animated-shape shape3"></div>
        <div class="animated-shape shape4"></div>
    </div>

    <!-- Main content -->
    <div class="failure-container">
        <div class="failure-header" data-aos="fade-down">
            <div class="error-circle">
                <div class="background"></div>
                <div class="error-x">×</div>
                <div class="error-pulse"></div>
            </div>
            <h1 class="failure-title animate__animated animate__headShake">Payment Failed!</h1>
            <p class="failure-subtitle">
                We couldn't process your payment. Don't worry, your order is saved and you can try again.
            </p>
        </div>

        <div class="row">
            <!-- Left column with payment retry options -->
            <div class="col-lg-5" data-aos="fade-right" data-aos-delay="200">
                <div class="retry-payment-container glass-effect" data-aos="fade-up" data-aos-delay="300">
                    <div class="retry-payment-header">
                        <div class="retry-payment-icon">
                            <i class="fas fa-redo-alt"></i>
                        </div>
                        <h3 class="retry-payment-title">Retry Payment</h3>
                    </div>
                    <p class="retry-payment-description">
                        Your order is saved but the payment was not successful. You can retry payment now or later from your orders page.
                    </p>
                    <div class="payment-options">
                        <div class="payment-option active" data-payment="razorpay">
                            <div class="payment-option-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="payment-option-label">Credit/Debit Card</div>
                        </div>
                        <div class="payment-option" data-payment="upi">
                            <div class="payment-option-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="payment-option-label">UPI</div>
                        </div>
                        <div class="payment-option" data-payment="netbanking">
                            <div class="payment-option-icon">
                                <i class="fas fa-university"></i>
                            </div>
                            <div class="payment-option-label">Net Banking</div>
                        </div>
                        <div class="payment-option" data-payment="wallet">
                            <div class="payment-option-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="payment-option-label">Wallet</div>
                        </div>
                    </div>
                    <a href="/checkout-payment" class="btn btn-primary-action btn-action w-100" id="retryPaymentBtn">
                        <i class="fas fa-redo-alt me-2"></i>Retry Payment Now
                        <span class="btn-shine"></span>
                    </a>
                </div>

                <div class="order-illustration">
                    <img 
                       src="/Uploads/payment_failed.png" 
                        alt="Payment Failed" 
                        class="img-fluid floating" 
                        onerror="this.src='/Uploads/placeholder.jpg'"
                    />
                    <div class="illustration-shadow"></div>
                </div>

                <!-- Action buttons -->
                <div class="action-buttons">
                    <a href="/checkout-payment" class="btn btn-primary-action btn-action w-100 mb-3 shake" data-aos="fade-up" data-aos-delay="500">
                        <i class="fas fa-redo-alt me-2"></i>Retry Payment
                        <span class="btn-shine"></span>
                    </a>
                    <a href="/orders" class="btn btn-secondary-action btn-action w-100 mb-3" data-aos="fade-up" data-aos-delay="600">
                        <i class="fas fa-history me-2"></i>View All Orders
                    </a>
                    <a href="/" class="btn btn-secondary-action btn-action w-100 mb-3" data-aos="fade-up" data-aos-delay="700">
                        <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
                    </a>
                </div>
            </div>

            <!-- Right column with product details -->
            <div class="col-lg-7" data-aos="fade-left" data-aos-delay="300">
                <!-- Order items summary - FEATURED PROMINENTLY -->
                <div class="order-card glass-effect mb-4">
                    <div class="order-card-header">
                        <h3>Your Cart Items</h3>
                        <p class="text-muted mb-0">Items you were trying to purchase</p>
                    </div>
                    <div class="order-card-body p-0">
                        <% if (typeof order !== 'undefined' && order && order.order_items && order.order_items.length > 0) { %>
                            <div class="list-group list-group-flush">
                                <% order.order_items.forEach(item => { %>
                                    <div class="list-group-item product-item">
                                        <div class="d-flex align-items-center">
                                            <div class="product-image-container me-3">
                                                <% if (item.itemImage) { %>
                                                    <img 
                                                        src="<%= item.itemImage %>" 
                                                        alt="<%= item.product_name %>" 
                                                        class="product-image"
                                                        onerror="this.src='/Uploads/placeholder.jpg'"
                                                    >
                                                    <div class="product-quantity-badge"><%= item.quantity %></div>
                                                <% } else { %>
                                                    <div class="product-image-placeholder">
                                                        <i class="fas fa-tshirt"></i>
                                                    </div>
                                                    <div class="product-quantity-badge"><%= item.quantity %></div>
                                                <% } %>
                                            </div>
                                            <div class="product-details flex-grow-1">
                                                <h5 class="product-name mb-1">
                                                    <%= item.product_name || 'Unnamed Product' %>
                                                </h5>
                                                <div class="product-meta">
                                                    <span class="product-size">
                                                        <i class="fas fa-ruler-combined me-1"></i> Size: <%= item.size || 'N/A' %>
                                                    </span>
                                                    <span class="product-quantity ms-3">
                                                        <i class="fas fa-cubes me-1"></i> Qty: <%= item.quantity || 1 %>
                                                    </span>
                                                </div>
                                                <div class="product-price mt-2">
                                                    <span class="price-label">Price:</span>
                                                    <span class="price-value">₹<%= (item.price !== undefined ? item.price.toFixed(2) : '0.00') %></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                            <div class="order-summary p-3 bg-light">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Subtotal:</span>
                                    <span class="fw-bold">₹<%= ((order.total || 0) - ((order.total || 0) > 8000 ? 0 : 200) + (order.discount || 0)).toFixed(2) %></span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Shipping:</span>
                                    <span>
                                        <% if ((order.total || 0) > 8000) { %>
                                            <span class="text-success">Free</span>
                                        <% } else { %>
                                            ₹200.00
                                        <% } %>
                                    </span>
                                </div>
                                <% if (order.discount > 0) { %>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Discount:</span>
                                        <span class="text-success">-₹<%= order.discount.toFixed(2) %></span>
                                    </div>
                                <% } %>
                                <div class="d-flex justify-content-between align-items-center fw-bold fs-5 mt-3 pt-2 border-top">
                                    <span>Total:</span>
                                    <span>₹<%= (order.total || 0).toFixed(2) %></span>
                                </div>
                            </div>
                        <% } else { %>
                            <div class="p-4 text-center">
                                <div class="empty-cart-icon mb-3">
                                    <i class="fas fa-shopping-cart fa-3x text-muted"></i>
                                </div>
                                <h5>No items to display</h5>
                                <p class="text-muted">We couldn't retrieve your order items. Please check your cart or continue shopping.</p>
                                <a href="/" class="btn btn-primary mt-2">
                                    <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Customer support -->
                <div class="support-card glass-effect" data-aos="fade-up" data-aos-delay="800">
                    <div class="support-header">
                        <div class="support-icon">
                            <i class="fas fa-headset"></i>
                        </div>
                        <h4>Need Help?</h4>
                    </div>
                    <div class="support-content">
                        <p>Having trouble with your payment? Our customer support team is here to help you resolve any issues.</p>
                        <div class="support-options">
                            <a href="mailto:support@elitewear.com" class="support-option">
                                <div class="support-option-icon">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div class="support-option-text">
                                    <h6>Email Us</h6>
                                    <p>support@elitewear.com</p>
                                </div>
                            </a>
                            <a href="tel:+911234567890" class="support-option">
                                <div class="support-option-icon">
                                    <i class="fas fa-phone-alt"></i>
                                </div>
                                <div class="support-option-text">
                                    <h6>Call Us</h6>
                                    <p>+91 1234567890</p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating chat button -->
    <div class="floating-chat-btn" id="floatingChatBtn">
        <i class="fas fa-comment-dots"></i>
        <span class="chat-pulse"></span>
    </div>

    <!-- Chat modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-header">
            <div class="chat-header-title">
                <i class="fas fa-headset me-2"></i>
                <h5>Customer Support</h5>
            </div>
            <button class="chat-close-btn" id="closeChatBtn"><i class="fas fa-times"></i></button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-message support">
                <div class="chat-avatar">
                    <i class="fas fa-headset"></i>
                </div>
                <div class="chat-bubble">
                    <p>Hello! I'm sorry to hear you're having trouble with your payment. How can I help you today?</p>
                    <span class="chat-time">Just now</span>
                </div>
            </div>
        </div>
        <div class="chat-footer">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="sendChatBtn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <%- include("../partials/user/footer") %>

    <!-- Hidden audio element for alert sound -->
    <audio id="alertSound" preload="auto">
        <source src="/Uploads/alert-sound.mp3" type="audio/mpeg">
        <!-- Fallback alert sound -->
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Initialize AOS animation library
        document.addEventListener('DOMContentLoaded', function() {
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true,
                disable: window.innerWidth < 768 ? 'phone' : false // Disable animations on small screens for better performance
            });
            
            // Show toast notification
            const toastEl = document.querySelector('.toast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            
            // Play alert sound
            playAlertSound();
            
            // Add event listeners
            setupEventListeners();
            
            // Create lightning effect
            createLightningEffect();
            
            // Check for viewport changes
            window.addEventListener('resize', function() {
                if (window.innerWidth < 768) {
                    AOS.init({disable: 'phone'});
                }
            });
        });
        
        // Play alert sound
        function playAlertSound() {
            const audio = document.getElementById('alertSound');
            
            // Check if browser supports audio
            if (audio) {
                // Try to play with user interaction to avoid autoplay restrictions
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Audio playback was prevented by the browser. Will play on user interaction.');
                    });
                }
            }
        }
        
        // Create lightning effect
        function createLightningEffect() {
            const lightning = document.getElementById('lightning');
            
            // Initial flash
            setTimeout(() => {
                flashLightning();
            }, 1000);
            
            // Periodic flashes
            setInterval(() => {
                flashLightning();
            }, 8000);
        }
        
        function flashLightning() {
            const lightning = document.getElementById('lightning');
            lightning.style.opacity = '0.1';
            
            setTimeout(() => {
                lightning.style.opacity = '0.3';
                
                setTimeout(() => {
                    lightning.style.opacity = '0.1';
                    
                    setTimeout(() => {
                        lightning.style.opacity = '0';
                    }, 100);
                }, 100);
            }, 100);
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Sound control button
            const soundControl = document.getElementById('soundControl');
            if (soundControl) {
                soundControl.addEventListener('click', function() {
                    playAlertSound();
                    
                    // Add animation
                    this.classList.add('animate__animated', 'animate__heartBeat');
                    setTimeout(() => {
                        this.classList.remove('animate__animated', 'animate__heartBeat');
                    }, 1000);
                });
            }
            
            // Payment options
            const paymentOptions = document.querySelectorAll('.payment-option');
            paymentOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    paymentOptions.forEach(opt => opt.classList.remove('active'));
                    
                    // Add active class to clicked option
                    this.classList.add('active');
                    
                    // Update retry payment button with selected payment method
                    const paymentMethod = this.getAttribute('data-payment');
                    const retryBtn = document.getElementById('retryPaymentBtn');
                    
                    if (retryBtn) {
                        retryBtn.href = `/checkout-payment?method=${paymentMethod}`;
                    }
                });
            });
            
            // Chat functionality
            const floatingChatBtn = document.getElementById('floatingChatBtn');
            const closeChatBtn = document.getElementById('closeChatBtn');
            const chatModal = document.getElementById('chatModal');
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            const chatBody = document.getElementById('chatBody');
            
            if (floatingChatBtn) {
                floatingChatBtn.addEventListener('click', function() {
                    if (chatModal) {
                        chatModal.classList.add('open');
                    }
                });
            }
            
            if (closeChatBtn) {
                closeChatBtn.addEventListener('click', function() {
                    if (chatModal) {
                        chatModal.classList.remove('open');
                    }
                });
            }
            
            if (sendChatBtn && chatInput && chatBody) {
                sendChatBtn.addEventListener('click', function() {
                    const message = chatInput.value.trim();
                    if (message) {
                        // Add user message
                        const userMessageHTML = `
                            <div class="chat-message user">
                                <div class="chat-bubble">
                                    <p>${message}</p>
                                    <span class="chat-time">Just now</span>
                                </div>
                            </div>
                        `;
                        chatBody.insertAdjacentHTML('beforeend', userMessageHTML);
                        
                        // Clear input
                        chatInput.value = '';
                        
                        // Scroll to bottom
                        chatBody.scrollTop = chatBody.scrollHeight;
                        
                        // Simulate response after delay
                        setTimeout(() => {
                            const responses = [
                                "I understand your concern. Please try using a different payment method.",
                                "Let me help you resolve this issue. Could you try clearing your browser cache and trying again?",
                                "I'm sorry for the inconvenience. Our payment system might be experiencing temporary issues. Please try again in a few minutes.",
                                "Thank you for your patience. You can also try completing your purchase on our mobile app if you continue to face issues."
                            ];
                            
                            const responseHTML = `
                                <div class="chat-message support">
                                    <div class="chat-avatar">
                                        <i class="fas fa-headset"></i>
                                    </div>
                                    <div class="chat-bubble">
                                        <p>${responses[Math.floor(Math.random() * responses.length)]}</p>
                                        <span class="chat-time">Just now</span>
                                    </div>
                                </div>
                            `;
                            
                            chatBody.insertAdjacentHTML('beforeend', responseHTML);
                            
                            // Scroll to bottom
                            chatBody.scrollTop = chatBody.scrollHeight;
                        }, 1000);
                    }
                });
                
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatBtn.click();
                    }
                });
            }
            
            // Make sure all images are loaded properly
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                img.addEventListener('error', function() {
                    this.src = '/Uploads/placeholder.jpg';
                });
            });
            
            // Add shake animation to retry payment button periodically
            const retryBtn = document.querySelector('.btn-primary-action');
            if (retryBtn) {
                setInterval(() => {
                    retryBtn.classList.add('shake');
                    setTimeout(() => {
                        retryBtn.classList.remove('shake');
                    }, 800);
                }, 5000);
            }
        }
    </script>
</body>
</html>
